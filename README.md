# Ввод показаний счетчиков

Веб-приложение для ввода и управления показаниями счетчиков с использованием Appwrite в качестве backend.

## Исправления логики отображения последних показаний

### Проблема
В столбце "Дата предыдущих показаний" отображались не последние показания, а старые данные из коллекции `meters`.

### Причины и решения

1. **Неправильный источник данных**
   - **Проблема**: Данные брались только из коллекции `meters`, которая содержит базовые данные счетчиков
   - **Решение**: Добавлено получение последних показаний из коллекции `meter_readings`

2. **Отсутствие фильтрации по городу**
   - **Проблема**: Показывались показания всех счетчиков, а не только выбранного города
   - **Решение**: Добавлена фильтрация показаний по счетчикам выбранного города

3. **Неправильная логика выбора последних данных**
   - **Проблема**: Логика сортировки не учитывала реальные даты показаний
   - **Решение**: Реализована правильная логика поиска последних показаний по дате

### Измененные файлы

- `script-appwrite.js` - исправлена логика получения последних показаний
- `test-readings.html` - создана страница для тестирования показаний

### Логика работы

1. **Загрузка счетчиков города** - получаем все счетчики для выбранного города
2. **Загрузка всех показаний** - получаем все показания из коллекции `meter_readings`
3. **Фильтрация по городу** - оставляем только показания счетчиков выбранного города
4. **Поиск последних показаний** - для каждого счетчика находим показание с самой поздней датой
5. **Отображение в таблице** - показываем последние показания в столбце "Дата предыдущих показаний"

### Тестирование

Для проверки исправлений:

1. Откройте `http://localhost:8081/test-readings.html`
2. Выберите город
3. Нажмите "Загрузить показания для города"
4. Проверьте, что отображаются последние показания
5. Перейдите на основную страницу и убедитесь, что данные обновились

## Исправления проблемы сохранения показаний

### Проблема
После сохранения показаний счетчиков данные не обновлялись в таблице - отображались старые показания вместо новых.

### Причины и решения

1. **Отсутствие обновления данных счетчиков**
   - **Проблема**: Показания сохранялись только в коллекцию `meter_readings`, но не обновляли данные в коллекции `meters`
   - **Решение**: Добавлено обновление полей `prev_date` и `prev_reading` в коллекции `meters` после сохранения

2. **Неполное обновление таблицы**
   - **Проблема**: После сохранения таблица не очищалась и не обновлялась с новыми данными
   - **Решение**: Добавлена очистка полей ввода и перезагрузка данных после сохранения

3. **Отсутствие детального логирования**
   - **Проблема**: Сложно было диагностировать проблемы с сохранением
   - **Решение**: Добавлено подробное логирование всех этапов сохранения

### Измененные файлы

- `script-appwrite.js` - исправлена логика сохранения показаний
- `test-save.html` - создана страница для тестирования сохранения
- `index.html` - добавлена ссылка на тестовую страницу

### Тестирование

Для проверки исправлений:

1. Откройте `test-save.html` в браузере
2. Нажмите "Проверить подключение"
3. Нажмите "Запустить тест сохранения"
4. Проверьте логи для диагностики
5. После теста перейдите на основную страницу и проверьте, что данные обновились

## Исправления ошибки инициализации Appwrite

### Проблема
Приложение выдавало ошибку "Ошибка инициализации Appwrite" при загрузке страницы.

### Причины и решения

1. **Отсутствие импорта классов Appwrite**
   - **Проблема**: В `appwrite-config.js` не был импортирован класс `Client` и `Databases` из Appwrite SDK
   - **Решение**: Добавлена проверка загрузки SDK и правильный импорт классов

2. **Отсутствие импорта Query**
   - **Проблема**: В `script-appwrite.js` использовался `Query` без импорта
   - **Решение**: Добавлен импорт `Query` и `ID` из Appwrite SDK

3. **Проблемы с глобальной доступностью констант**
   - **Проблема**: Константы из `appwrite-config.js` не были доступны в других файлах
   - **Решение**: Добавлено присвоение констант к `window` объекту

4. **Недостаточная обработка ошибок**
   - **Проблема**: Ошибки инициализации не обрабатывались должным образом
   - **Решение**: Добавлена детальная обработка ошибок с логированием

### Измененные файлы

- `appwrite-config.js` - исправлена инициализация клиента Appwrite
- `script-appwrite.js` - добавлены импорты и улучшена обработка ошибок
- `index.html` - добавлена проверка загрузки SDK
- `test-connection.html` - создана страница для тестирования подключения

### Тестирование

Для проверки исправлений:

1. Откройте `test-connection.html` в браузере
2. Нажмите кнопки тестирования по порядку
3. Проверьте консоль браузера для детальной информации

## Структура проекта

```
├── index.html              # Главная страница приложения
├── appwrite-config.js      # Конфигурация Appwrite
├── script-appwrite.js      # Основная логика приложения
├── test-connection.html    # Страница тестирования подключения
├── style.css              # Стили приложения
└── README.md              # Документация
```

## Конфигурация Appwrite

- **Endpoint**: `https://cloud.appwrite.io/v1`
- **Project ID**: `68790cc0001f9d5ee482`
- **Database ID**: `meter_readings_db`

## Коллекции

- `cities` - города
- `meter_types` - типы счетчиков
- `meters` - счетчики
- `tariffs` - тарифы
- `meter_readings` - показания счетчиков

## Использование

1. Откройте `index.html` в браузере
2. Выберите город из выпадающего списка
3. Введите текущие показания счетчиков
4. Нажмите "Рассчитать" для подсчета суммы
5. Нажмите "Сохранить" для сохранения показаний

## Технологии

- HTML5
- CSS3
- JavaScript (ES6+)
- Appwrite SDK v11.0.0 