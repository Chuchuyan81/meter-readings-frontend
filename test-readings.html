<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        
        .readings-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .readings-table th,
        .readings-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .readings-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .latest {
            background-color: #d4edda;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π</h1>
        
        <div class="test-section">
            <h3>üèôÔ∏è –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞</h3>
            <select id="citySelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
            </select>
            <button onclick="loadCityReadings()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –≥–æ—Ä–æ–¥–∞</button>
            <div id="cityLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä –í—Å–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –≤ –±–∞–∑–µ</h3>
            <button onclick="loadAllReadings()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</button>
            <div id="allReadingsLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º —Å—á–µ—Ç—á–∏–∫–æ–≤</h3>
            <div id="latestReadingsTable"></div>
            <div id="latestReadingsLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
            <button onclick="runDiagnostics()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
            <div id="diagnosticsLog" class="log"></div>
        </div>
    </div>

    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Appwrite -->
    <script src="appwrite-config.js"></script>
    
    <script>
        let citiesMap = {};
        let meterTypesMap = {};

        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function loadCities() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                if (!databases) {
                    log('cityLog', 'Databases –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                    return;
                }
                
                const response = await databases.listDocuments(DATABASE_ID, CITIES_COLLECTION_ID);
                const citySelect = document.getElementById('citySelect');
                citySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>';
                
                response.documents.forEach((city, index) => {
                    const option = document.createElement('option');
                    option.value = city.$id;
                    option.textContent = city.name;
                    citySelect.appendChild(option);
                    
                    const simpleCityId = String(index + 1);
                    citiesMap[city.$id] = simpleCityId;
                });
                
                log('cityLog', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥–æ—Ä–æ–¥–æ–≤: ${response.documents.length}`, 'success');
            } catch (error) {
                log('cityLog', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤: ${error.message}`, 'error');
            }
        }

        async function loadCityReadings() {
            const cityId = document.getElementById('citySelect').value;
            if (!cityId) {
                log('cityLog', '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥', 'warning');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
            if (!databases) {
                log('cityLog', 'Databases –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }

            log('cityLog', `–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${cityId}`, 'info');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –≥–æ—Ä–æ–¥–∞
                const simpleCityId = citiesMap[cityId];
                const metersResponse = await databases.listDocuments(
                    DATABASE_ID,
                    METERS_COLLECTION_ID,
                    [Appwrite.Query.equal('city_id', simpleCityId)]
                );
                
                log('cityLog', `–ù–∞–π–¥–µ–Ω–æ —Å—á–µ—Ç—á–∏–∫–æ–≤: ${metersResponse.documents.length}`, 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è
                const readingsResponse = await databases.listDocuments(
                    DATABASE_ID,
                    METER_READINGS_COLLECTION_ID
                );
                
                log('cityLog', `–í—Å–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏–π –≤ –±–∞–∑–µ: ${readingsResponse.documents.length}`, 'info');
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –≥–æ—Ä–æ–¥–∞
                const cityMeterIds = metersResponse.documents.map(meter => meter.$id);
                const cityReadings = readingsResponse.documents.filter(reading => 
                    cityMeterIds.includes(reading.meter_id)
                );
                
                log('cityLog', `–ü–æ–∫–∞–∑–∞–Ω–∏–π –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${cityReadings.length}`, 'info');
                
                // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
                const latestReadings = {};
                cityReadings.forEach(reading => {
                    const meterId = reading.meter_id;
                    if (!latestReadings[meterId] || new Date(reading.reading_date) > new Date(latestReadings[meterId].reading_date)) {
                        latestReadings[meterId] = reading;
                    }
                });
                
                log('cityLog', `–ü–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ: ${Object.keys(latestReadings).length}`, 'success');
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                displayLatestReadings(metersResponse.documents, latestReadings, cityReadings);
                
            } catch (error) {
                log('cityLog', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function loadAllReadings() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
            if (!databases) {
                log('allReadingsLog', 'Databases –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            try {
                const readingsResponse = await databases.listDocuments(
                    DATABASE_ID,
                    METER_READINGS_COLLECTION_ID
                );
                
                log('allReadingsLog', `–í—Å–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏–π: ${readingsResponse.documents.length}`, 'info');
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—á–µ—Ç—á–∏–∫–∞–º
                const readingsByMeter = {};
                readingsResponse.documents.forEach(reading => {
                    if (!readingsByMeter[reading.meter_id]) {
                        readingsByMeter[reading.meter_id] = [];
                    }
                    readingsByMeter[reading.meter_id].push(reading);
                });
                
                log('allReadingsLog', `–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤: ${Object.keys(readingsByMeter).length}`, 'info');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
                Object.keys(readingsByMeter).forEach(meterId => {
                    const readings = readingsByMeter[meterId];
                    const latest = readings.reduce((latest, current) => 
                        new Date(current.reading_date) > new Date(latest.reading_date) ? current : latest
                    );
                    
                    log('allReadingsLog', `–°—á–µ—Ç—á–∏–∫ ${meterId}: ${readings.length} –ø–æ–∫–∞–∑–∞–Ω–∏–π, –ø–æ—Å–ª–µ–¥–Ω–µ–µ: ${latest.reading_date} (${latest.reading})`, 'info');
                });
                
            } catch (error) {
                log('allReadingsLog', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function displayLatestReadings(meters, latestReadings, allReadings) {
            const container = document.getElementById('latestReadingsTable');
            
            let html = `
                <table class="readings-table">
                    <thead>
                        <tr>
                            <th>–¢–∏–ø —Å—á–µ—Ç—á–∏–∫–∞</th>
                            <th>ID —Å—á–µ—Ç—á–∏–∫–∞</th>
                            <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞</th>
                            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–∫–∞–∑–∞–Ω–∏–µ</th>
                            <th>–í—Å–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏–π</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            meters.forEach(meter => {
                const latestReading = latestReadings[meter.$id];
                const readingsCount = allReadings.filter(r => r.meter_id === meter.$id).length;
                const isLatest = latestReading ? 'latest' : '';
                
                html += `
                    <tr class="${isLatest}">
                        <td>${meter.meter_type_id}</td>
                        <td>${meter.$id}</td>
                        <td>${latestReading ? latestReading.reading_date : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td>
                        <td>${latestReading ? latestReading.reading : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td>
                        <td>${readingsCount}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            log('latestReadingsLog', `–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${meters.length} —Å—á–µ—Ç—á–∏–∫–æ–≤`, 'success');
        }

        async function runDiagnostics() {
            log('diagnosticsLog', '=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ===', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
            if (!databases) {
                log('diagnosticsLog', 'Databases –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                const citiesCount = await databases.listDocuments(DATABASE_ID, CITIES_COLLECTION_ID);
                const metersCount = await databases.listDocuments(DATABASE_ID, METERS_COLLECTION_ID);
                const readingsCount = await databases.listDocuments(DATABASE_ID, METER_READINGS_COLLECTION_ID);
                
                log('diagnosticsLog', `–ì–æ—Ä–æ–¥–æ–≤: ${citiesCount.documents.length}`, 'info');
                log('diagnosticsLog', `–°—á–µ—Ç—á–∏–∫–æ–≤: ${metersCount.documents.length}`, 'info');
                log('diagnosticsLog', `–ü–æ–∫–∞–∑–∞–Ω–∏–π: ${readingsCount.documents.length}`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π
                const readingsByMeter = {};
                readingsCount.documents.forEach(reading => {
                    if (!readingsByMeter[reading.meter_id]) {
                        readingsByMeter[reading.meter_id] = 0;
                    }
                    readingsByMeter[reading.meter_id]++;
                });
                
                const metersWithReadings = Object.keys(readingsByMeter).length;
                const metersWithoutReadings = metersCount.documents.length - metersWithReadings;
                
                log('diagnosticsLog', `–°—á–µ—Ç—á–∏–∫–æ–≤ —Å –ø–æ–∫–∞–∑–∞–Ω–∏—è–º–∏: ${metersWithReadings}`, 'success');
                log('diagnosticsLog', `–°—á–µ—Ç—á–∏–∫–æ–≤ –±–µ–∑ –ø–æ–∫–∞–∑–∞–Ω–∏–π: ${metersWithoutReadings}`, 'warning');
                
            } catch (error) {
                log('diagnosticsLog', `–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', async function() {
            log('cityLog', '=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===', 'info');
            
            if (typeof Appwrite === 'undefined') {
                log('cityLog', 'Appwrite SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }
            log('cityLog', 'Appwrite SDK –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            log('cityLog', `DATABASE_ID: ${typeof DATABASE_ID !== 'undefined' ? DATABASE_ID : '–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù'}`, 'info');
            log('cityLog', `CITIES_COLLECTION_ID: ${typeof CITIES_COLLECTION_ID !== 'undefined' ? CITIES_COLLECTION_ID : '–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù'}`, 'info');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Appwrite
            try {
                if (!initAppwrite()) {
                    log('cityLog', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Appwrite', 'error');
                    return;
                }
                log('cityLog', 'Appwrite –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º databases –æ–±—ä–µ–∫—Ç
                if (!databases) {
                    log('cityLog', 'Databases –æ–±—ä–µ–∫—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω', 'error');
                    return;
                }
                log('cityLog', 'Databases –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                let authResult = await checkExistingSession();
                if (!authResult) {
                    log('cityLog', '–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∞–Ω–æ–Ω–∏–º–Ω—É—é —Å–µ—Å—Å–∏—é...', 'info');
                    authResult = await createAnonymousSession();
                    if (!authResult) {
                        log('cityLog', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—É—é —Å–µ—Å—Å–∏—é', 'error');
                        return;
                    }
                }
                log('cityLog', '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞
                await loadCities();
                
            } catch (error) {
                log('cityLog', `–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                log('cityLog', `–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: ${JSON.stringify(error)}`, 'error');
            }
        });
    </script>
</body>
</html> 